import numpy as np
import os
import copy
from DLT_USV import DLT_USV
from spatial_resection import spatial_resection
# from resection_test import world_to_image  
# from resection_test import read_camera_file, read_point_file
from estimate_focal import estimate_focal_length
from DLT_H import estimate_camera, visualize_reprojection


# -------- Configuration --------
# SHIFT_Y = [0.0, 0.5, 1.0, 2.0, 5.0]  # shifted in y direction (mm)
# OUTPUT_FILE = "analysis.txt"

# -------- input data --------
data = "dataset_19"

# -------- test data --------
# textbook p.287
if data == "dataset_1":
    object_points = np.array([
        [-390.93, -477.52, 0.07],
        [-101.5, -479.19, 0.11],
        [-23.22, -256.85, -0.09],
        [-116.88, -21.03, 0.07],
        [-392.17, -21.46, 0.11],
        [-477.54, -237.65, -0.16]
    ])

    image_points = np.array([
        [-0.0395, -6.3033],
        [6.6590, -6.2948],
        [9.0086, -1.3473],
        [7.3672, 4.5216],
        [0.2936, 4.7133],
        [-2.0348, -0.7755]
    ])

# GCPs from airborne image (6/10)
if data == "dataset_2":

    object_points = np.array([
        [495007554.4000, 5422937852.3000, 309420.5000],
        [495046191.4000, 5421266692.4000, 307264.5000],
        [494079965.1000, 5421040044.7000, 276610.5000],
        [493745171.6000, 5421745480.7000, 387269.5000], 
        [493907905.7000, 5423345190.3000, 296065.5000],
        [493739639.4000, 5422185482.6000, 349929.5000],
        [495052682.3000, 5421418508.4000, 326071.5000],
        [494915594.0000, 5422418093.0000, 314015.5000], 
        [494401710.3000, 5422370044.1000, 312793.5000],
        [494117943.6000, 5422167155.1000, 340958.5000],
    ])

    image_points = np.array([
        [37.0656, 49.7981],
        [38.9813, -42.5265],
        [-14.0247, -54.2079],
        [-33.9667, -16.8316],
        [-23.7441, 72.0058],
        [-33.7344, 8.2273],
        [39.6936, -34.4827],
        [31.9978, 21.0191],
        [3.5016, 18.3313],
        [-12.3710, 7.1727],
    ])

# Bild3 error-free
if data == "dataset_3":
    object_points = np.array([
        [-500.0000,     -500.0000,        0.0000],
        [-500.0000,     -250.0000,        0.0000],
        [-500.0000,        0.0000,        0.0000],
        [-500.0000,      250.0000,        0.0000],
        [-500.0000,      500.0000,        0.0000],
        [-250.0000,     -500.0000,        0.0000],
        [-250.0000,     -250.0000,        0.0000],
        [-250.0000,     -250.0000,      200.0000],
        [-250.0000,        0.0000,        0.0000],
        [-250.0000,      250.0000,        0.0000],
        [-250.0000,      250.0000,      200.0000],
        [-250.0000,      500.0000,        0.0000],
        [   0.0000,     -500.0000,        0.0000],
        [   0.0000,     -250.0000,        0.0000],
        [   0.0000,        0.0000,        0.0000],
        [   0.0000,        0.0000,      200.0000],
        [   0.0000,      250.0000,        0.0000],
        [   0.0000,      500.0000,        0.0000],
        [ 250.0000,     -500.0000,        0.0000],
        [ 250.0000,     -250.0000,        0.0000],
        [ 250.0000,     -250.0000,      200.0000],
        [ 250.0000,        0.0000,        0.0000],
        [ 250.0000,      250.0000,        0.0000],
        [ 250.0000,      250.0000,      200.0000],
        [ 250.0000,      500.0000,        0.0000],
        [ 500.0000,     -500.0000,        0.0000],
        [ 500.0000,     -250.0000,        0.0000],
        [ 500.0000,        0.0000,        0.0000],
        [ 500.0000,      250.0000,        0.0000],
        [ 500.0000,      500.0000,        0.0000],
    ], dtype=np.float64)
    

    image_points = np.array([
        [-6.0270,       -9.8859],
        [-5.5716,       -6.8237],
        [-5.1258,       -3.8271],
        [-4.6895,       -0.8938],
        [-4.2624,        1.9781],
        [-3.0817,      -10.3894],
        [-2.6525,       -7.2813],
        [-3.1975,       -7.8241],
        [-2.2325,       -4.2405],
        [-1.8216,       -1.2649],
        [-2.2635,       -1.1413],
        [-1.4194,        1.6476],
        [-0.0567,      -10.9065],
        [ 0.3448,       -7.7511],
        [ 0.7374,       -4.6649],
        [ 0.5690,       -4.9172],
        [ 1.1214,       -1.6458],
        [ 1.4972,        1.3086],
        [ 3.0514,      -11.4378],
        [ 3.4233,       -8.2336],
        [ 3.5582,       -8.9020],
        [ 3.7869,       -5.1007],
        [ 4.1425,       -2.0367],
        [ 4.3546,       -1.9957],
        [ 4.4904,        0.9606],
        [ 6.2459,      -11.9839],
        [ 6.5864,       -8.7294],
        [ 6.9194,       -5.5483],
        [ 7.2448,       -2.4382],
        [ 7.5632,        0.6034],
    ], dtype=np.float64)

# Bild6 with noise
if data == "dataset_4":
    object_points = np.array([
        [-500.0000,     -500.0000,        0.0000],
        [-500.0000,     -250.0000,        0.0000],
        [-500.0000,        0.0000,        0.0000],
        [-500.0000,      250.0000,        0.0000],
        [-500.0000,      500.0000,        0.0000],
        [-250.0000,     -500.0000,        0.0000],
        [-250.0000,     -250.0000,        0.0000],
        [-250.0000,     -250.0000,      200.0000],
        [-250.0000,        0.0000,        0.0000],
        [-250.0000,      250.0000,        0.0000],
        [-250.0000,      250.0000,      200.0000],
        [-250.0000,      500.0000,        0.0000],
        [   0.0000,     -500.0000,        0.0000],
        [   0.0000,     -250.0000,        0.0000],
        [   0.0000,        0.0000,        0.0000],
        [   0.0000,        0.0000,      200.0000],
        [   0.0000,      250.0000,        0.0000],
        [   0.0000,      500.0000,        0.0000],
        [ 250.0000,     -500.0000,        0.0000],
        [ 250.0000,     -250.0000,        0.0000],
        [ 250.0000,     -250.0000,      200.0000],
        [ 250.0000,        0.0000,        0.0000],
        [ 250.0000,      250.0000,        0.0000],
        [ 250.0000,      250.0000,      200.0000],
        [ 250.0000,      500.0000,        0.0000],
        [ 500.0000,     -500.0000,        0.0000],
        [ 500.0000,     -250.0000,        0.0000],
        [ 500.0000,        0.0000,        0.0000],
        [ 500.0000,      250.0000,        0.0000],
        [ 500.0000,      500.0000,        0.0000],
    ], dtype=np.float64)
    
    image_points = np.array([
        [-6.0281,       -9.8859],
        [-5.5699,       -6.8234],
        [-5.1240,       -3.8267],
        [-4.6912,       -0.8913],
        [-4.2631,        1.9784],
        [-3.0829,      -10.3901],
        [-2.6505,       -7.2816],
        [-3.1972,       -7.8220],
        [-2.2328,       -4.2398],
        [-1.8229,       -1.2637],
        [-2.2659,       -1.1402],
        [-1.4217,        1.6474],
        [-0.0558,      -10.9075],
        [ 0.3436,       -7.7522],
        [ 0.7385,       -4.6635],
        [ 0.5695,       -4.9181],
        [ 1.1206,       -1.6457],
        [ 1.4958,        1.3073],
        [ 3.0521,      -11.4400],
        [ 3.4225,       -8.2336],
        [ 3.5582,       -8.9015],
        [ 3.7863,       -5.1010],
        [ 4.1424,       -2.0369],
        [ 4.3551,       -1.9961],
        [ 4.4899,        0.9598],
        [ 6.2468,      -11.9834],
        [ 6.5870,       -8.7303],
        [ 6.9181,       -5.5480],
        [ 7.2428,       -2.4383],
        [ 7.5636,        0.6042],
    ])

# Freyburg Simulation
if data == "dataset_5":

    object_points = np.array([
        [693554997.681,  5677022970.337,  132966.165],
        [693551503.662,  5677022325.684,  128101.690],
        [693551548.096,  5677022290.894,  119860.368],
        [693558260.742,  5677023692.566,  119871.850],
        [693558290.771,  5677023696.143,  128098.283],
        [693555250.000,  5677023000.000,  128894.119],
    ])

    image_points = np.array([
        [-1.848, -151.319],
        [65.543,  -65.213],
        [64.866,   94.231],
        [-58.531,   84.455],
        [-59.038,  -58.675],
        [-6.466,  -76.374],
    ])

    # uv2 = np.array([
    #     [-1.848,     -120.768],
    #     [65.543,      -34.633],
    #     [64.866,      124.812],
    #     [-58.531,      114.977],
    #     [-59.038,      -28.153],
    #     [-6.466 ,     -45.824],
    # ])

    # # read input files
    # camera_file = 'cam.inp'
    # object_file = 'points.inp'
    # # image_file = 'image.inp'
    # iop, eop = read_camera_file(camera_file)
    # labels, X, Y, Z = read_point_file(object_file)
    # object_points = np.column_stack((X, Y, Z))
    
# BLDAM_MBA-4-b-29_141_13.jpg
if data == "dataset_6":
    object_points = np.array([
        [693557000.000, 5677030000.000, 138017.105],
        [693553687.500, 5677029000.000, 142071.091],
        [693555125.000, 5677023000.000, 132883.728],
        [693553687.500, 5677023000.000, 124549.614],
        [693563687.500, 5677031000.000, 127996.834],
        [693568750.000, 5677033000.000, 128041.107]
    ])

    image_points = -np.array([
        [-57.31896223505470, 95.58870059369490],
        [-80.35110314329490, 130.0307010917710],
        [-159.5837875397220, 42.35503645610240],
        [-166.15454134969800, -82.1211765870229],
        [0.7494787713964760, -19.55710537084210],
        [90.89274468380330, -1.587011222454860]
    ])

# BLDAM_MBA-4-b-30_141_14.jpg
if data == "dataset_7":
    object_points = np.array([
        [693557000.000, 5677030000.000, 138017.105],
        [693553687.500, 5677029000.000, 142071.091],
        [693555125.000, 5677023000.000, 132883.728],
        [693553687.500, 5677023000.000, 124549.614],
        [693563687.500, 5677031000.000, 127996.834],
        [693568750.000, 5677033000.000, 128041.107]
    ])

    image_points = -np.array([
        [-3.22563717051626, 107.16040907972133],
        [-22.950070647016148, 132.95421780511995],
        [-66.95503122924363, 71.57162213507428],
        [-75.64402849904216, -8.993581718532756],
        [46.23019992689659, 28.296183085688757],
        [110.31151332213142, 34.64119208981556]
    ])

# BLDAM_MBA-4-b-31_141_15.jpg
if data == "dataset_8":
    object_points = np.array([
        [693557000.000, 5677030000.000, 138017.105],
        [693553687.500, 5677029000.000, 142071.091],
        [693555125.000, 5677023000.000, 132883.728],
        [693553687.500, 5677023000.000, 124549.614],
        [693563687.500, 5677031000.000, 127996.834],
        [693568750.000, 5677033000.000, 128041.107]
    ])

    image_points = -np.array([
        [-37.60115451417980, 143.4868386788220],
        [-71.25188223452400, 184.24099654218000],
        [-126.90715868603100, 118.88236680222400],
        [-148.60189302231100, -7.541636688567620],
        [41.95541226747800, 32.79064333073600],
        [122.68061594466700, 34.30891934254770]
    ])

# BLDAM_MBA-4-b-29_141_9.jpg (3D model)
if data == "dataset_9":
    object_points = 1000*np.array([
        [693566.838783264160,5677035.846412658691,135.936294555664],  # A
        [693568.817710876465,5677037.652606964111,132.958251953125],  # A
        [693566.247276306152,5677039.349693298340,132.789718627930],  # B
        [693563.344390869141,5677038.758113861084,132.666900634766],  # C
        [693560.335166931152,5677038.230808258057,132.530303955078],  # D
        [693556.066471099854,5677033.514175415039,137.294937133789],  # E
        [693555.804050445557,5677037.067668914795,129.111618041992],  # F
        [693567.599967956543,5677038.526348114014,128.830291748047],  # G
        [693564.909683227539,5677039.067821502686,128.871643066406],  # H
        [693561.992759704590,5677038.509399414063,128.790496826172],  # I
        [693558.510234832764,5677037.421943664551,125.542976379395],  # J
        [693557.389408111572,5677037.169506072998,125.542480468750],  # K
        [693556.854785919189,5677039.963947296143,123.138229370117],  # L
        [693569.135612487793,5677038.136199951172,123.140907287598],  # M
        [693566.189414978027,5677039.871585845947,123.104827880859],  # N
        [693563.135467529297,5677039.239528656006,123.075523376465],  # 
        [693560.492229461670,5677038.710720062256,123.065841674805],  # 
        [693569.117820739746,5677038.151706695557,120.656890869141],  # 
        [693566.067176818848,5677039.923225402832,120.680145263672],  # 
        [693563.043769836426,5677039.249904632568,120.650459289551],  # 
        [693560.566658020020,5677038.770965576172,120.660514831543]
    ])

    image_points = np.array([
        [-80.0554243288801,176.7381473217940],  # A
        [-144.15235144261500,134.01013566959200],  # B
        [-85.31200733172220,164.22621418011800],  # C
        [-4.471041333675170,150.25448276990700],  # D
        [74.3940691603978,132.99111355986800],  # E
        [132.5852503641310,159.25439003234900],  # F
        [175.38854309296100,32.659985925711800],  # G
        [-118.04727433406200,50.276848886876600],  # H
        [-43.89650488508720,56.744475296351100],  # I
        [32.297763933818100,46.07529198692950],  # J
        [114.72726975173600,-47.63546502430270],  # K
        [138.570641471145,-48.33372428578440],  # L
        [187.08984087326100,-101.1319437246680],  # M
        [-154.62733139493600,-102.54591872916800],  # N
        [-82.44368920916680,-102.00585883161600],  # N
        [8.291828730095570,-104.13227648884700],  # N
        [73.19720914501430,-105.55716179430800],  # N
        [-153.74905216760400,-167.78624538357900],  # N
        [-80.88351617179360,-173.17811611833300],  # N
        [9.836727346123890,-170.69165852940100],  # N
        [74.06239601119400,-166.84359538057900] , # N
    ])


    # BLDAM_MBA-4-b-29_141_13.jpg

# BLDAM_MBA-4-b-29_141_13.jpg (lidar)
if data == "dataset_10":
    object_points = 1000*np.array([
        [693528.91,5677034.083,153.102005005],  # A
        [693533.293,5677024.884,146.179000854],  # B
        [693555.453,5677023.688,132.970993042],  # C
        [693552.436,5677023.145,128.507995605],  # D
        [693559.279,5677024.543,128.552001953],  # E
        [693553.519,5677023.464,124.528999329],  # F
        [693556.499,5677024.107,124.583999634],  # G
        [693548.055,5677023.087,122.916999817],  # H
        [693556.006,5677023.901,120.072998047],  # I
        [693560.654,5677024.977,122.222999573],  # J
        [693564.842,5677026.323,121.807998657],  # K
        [693558.096,5677030.177,128.610992432],  # L
        [693557.477,5677030.472,137.73500061],  # M
        [693553.944,5677029.893,142.18800354],  # N
        [693553.528,5677033.158,147.432006836],  # N
        [693556.758,5677034.122,142.248001099],  # N
        [693567.161,5677036.208,134.886001587],  # N
        [693564.073,5677031.696,127.800003052],  # N
        [693566.814,5677032.297,127.82900238],  # N
        [693569.134,5677033.898,127.777999878],  # N
        [693569.68,5677036.677,127.782997131],  # N
        [693565.528,5677032.094,131.802993774],  # N
        [693568.231,5677032.844,131.899993896],  # N
        [693569.941,5677035.208,131.645004272],  # N
        [693569.338,5677038.175,131.664993286],  # N
        [693563.542,5677031.784,122.652999878],  # N
        [693566.281,5677032.431,122.891998291],  # N
        [693569.22,5677034.509,122.873001099],  # N
        [693569.802,5677038.228,122.17199707],  # N
        [693565.943,5677031.526,119.722000122],  # N
        [693568.804,5677032.383,119.793998718],  # N
        [693570.53,5677035.392,119.731002808]  # N
    ])

    image_points = np.array([
        [-109.5640562150900,95.41800337637950],  # A
        [-176.92445486670900,79.76506478631640],  # B
        [-162.19649225658300,42.959271744263700],  # C
        [-175.73892227270500,-25.9840083378117],  # D
        [-139.4726985522820,-6.339125289733550],  # E
        [-168.85371374599000,-81.16772789204280],  # F
        [-154.32116859641400,-78.56433305649200],  # G
        [-180.64064357483700,-104.13687907459000],  # H
        [-157.31431270050600,-141.61360539786500],  # I
        [-127.70856742716600,-112.10556885479900],  # J
        [-80.72043903789470,-121.37812735790200],  # K
        [-59.3841093034996,-24.20462379424710],  # L
        [-58.003159248945600,97.30378187068790],  # M
        [-82.64204406663740,132.81222010520000],  # N
        [-46.483299949517200,174.13215648596000],  # N
        [-22.489292751640700,135.34070491420600],  # N
        [96.0248831566434,101.64856341025200],  # N
        [0.7556141807937420,-19.048859793400400],  # N
        [38.3897601250672,-8.601625221880260],  # N
        [91.92111648509130,-4.091824493407360],  # N
        [138.22854072011300,-9.422378556190670] , # N
        [20.90315436350900,51.19720335900900],  # N
        [63.136124546061500,67.54821654425930] , # N
        [121.96655104466900,70.07887265838320],  # N
        [148.51401306040000,49.674032819276900],  # N
        [-5.44889019167195,-101.14047801282200],  # N
        [34.87550279284120,-99.89306322297680] , # N
        [102.98174475222700,-101.31852503243400] , # N
        [159.2424316446010,-113.890381661157] , # N
        [18.62979790577620,-157.00924433153700],  # N
        [69.5588450828082,-161.03375836631000],  # N
        [137.66834399987000,-163.11603997372700]  # N
    ])

# BLDAM_MBA-4-b-30_141_9.jpg (lidar)
if data == "dataset_11":
    object_points = 1000*np.array([
        [693567.161,5677036.208,134.886001587],  # A
        [693569.338,5677038.175,131.664993286],  # A
        [693566.651,5677039.985,131.772003174],  # B
        [693563.831,5677039.454,131.621994019],  # C
        [693560.758,5677038.916,131.537994385],  # D
        [693556.34,5677034.03,136.199996948],  # E
        [693556.245,5677037.771,128.113006592],  # F
        [693568.001,5677039.202,127.819000244],  # G
        [693565.353,5677039.761,127.819999695],  # H
        [693562.409,5677039.206,127.78099823],  # I
        [693558.926,5677038.142,124.462997437],  # J
        [693557.728,5677037.869,124.464996338],  # K
        [693557.253,5677040.592,122.152999878],  # L
        [693569.491,5677038.814,122.149002075],  # M
        [693566.467,5677040.565,122.134002686],  # N
        [693563.416,5677039.877,122.108001709],  # 
        [693560.845,5677039.392,122.093002319],  # 
        [693569.436,5677038.785,119.713996887],  # 
        [693566.476,5677040.574,119.723999023],  # 
        [693563.421,5677039.92,119.700996399],  # 
        [693560.953,5677039.448,119.733001709]
    ])

    image_points = np.array([
        [-80.0554243288801,176.7381473217940],  # A
        [-144.15235144261500,134.01013566959200],  # B
        [-85.31200733172220,164.22621418011800],  # C
        [-4.471041333675170,150.25448276990700],  # D
        [74.3940691603978,132.99111355986800],  # E
        [132.5852503641310,159.25439003234900],  # F
        [175.38854309296100,32.659985925711800],  # G
        [-118.04727433406200,50.276848886876600],  # H
        [-43.89650488508720,56.744475296351100],  # I
        [32.297763933818100,46.07529198692950],  # J
        [114.72726975173600,-47.63546502430270],  # K
        [138.570641471145,-48.33372428578440],  # L
        [187.08984087326100,-101.1319437246680],  # M
        [-154.62733139493600,-102.54591872916800],  # N
        [-82.44368920916680,-102.00585883161600],  # N
        [8.291828730095570,-104.13227648884700],  # N
        [73.19720914501430,-105.55716179430800],  # N
        [-153.74905216760400,-167.78624538357900],  # N
        [-80.88351617179360,-173.17811611833300],  # N
        [9.836727346123890,-170.69165852940100],  # N
        [74.06239601119400,-166.84359538057900] , # N
    ])

# BLDAM_MBA-4-b-31_141_19.jpg (lidar)
if data == "dataset_12":
    object_points = 1000*np.array([
        [693522.044,5677026.282,132.720993042],  # A
        [693522.458,5677023.696,129.020004272],  # A
        [693525.607,5677024.436,128.593994141],  # B
        [693525.238,5677024.386,126.297996521],  # C
        [693525.921,5677024.523,126.214996338],  # D
        [693521.694,5677023.279,126.044998169],  # E
        [693522.406,5677022.827,126.028999329],  # F
        [693525.752,5677024.483,124.625999451],  # G
        [693524.326,5677024.098,119.51599884],  # H
        [693523.541,5677027.944,119.558998108],  # I
        [693522.496,5677023.008,119.728996277],  # J
        [693527.37,5677024.987,121.880996704],  # K
        [693529.714,5677019.139,119.84400177],  # L
        [693531.988,5677019.635,119.853996277],  # M
        [693531.271,5677019.535,121.488998413],  # N
        [693531.958,5677019.685,121.501998901],  # 
        [693533.189,5677019.947,121.511001587],  # 
        [693531.881,5677019.603,124.613998413],  # 
        [693531.536,5677019.495,126.775001526],  # 
        [693531.805,5677019.54,127.337997437]
    ])

    image_points = np.array([
        [-113.16480311132700,140.52287581699300],  # A
        [-136.99562469615900,98.0392156862745],  # B
        [-56.1011181332037,82.35294117647060],  # C
        [-63.20855614973260,26.797385620915000],  # D
        [-46.679630529897900,26.797385620915000],  # E
        [-159.67914438502700,22.875816993464000],  # F
        [-149.86874088478400,30.06535947712420],  # G
        [-52.66893534273210,-15.03267973856210],  # H
        [-84.51142440447250,-141.1764705882350],  # I
        [-64.14195430238210,-132.67973856209200],  # J
        [-143.42245989304800,-136.60130718954200],  # K
        [-6.0379192999514000,-83.00653594771250],  # L
        [33.281477880408400,-148.36601307189500],  # M
        [137.06368497812300,-147.05882352941200],  # N
        [102.32377248420000,-78.43137254901960],  # N
        [129.42148760330600,-77.77777777777780],  # N
        [187.58385999027700,-76.47058823529410],  # N
        [128.01166747690800,61.43790849673200],  # N
        [110.05347593582900,157.51633986928100],  # N
        [118.26932425862900,183.00653594771200]  # N
    ])

# BLDAM_MBA-4-b-29_141_13.jpg (3D Model)
if data == "dataset_13":
    object_points = 1000*np.array([
        [693528.526861190796,5677033.413684844971,155.384857177734],  # A
        [693532.822101593018,5677024.019067764282,147.137878417969],  # B
        [693555.093818664551,5677022.945007324219,133.880920410156],  # C
        [693552.084171295166,5677022.497753143311,129.626541137695],  # D
        [693558.725250244141,5677023.848133087158,129.778991699219],  # E
        [693553.324623107910,5677023.125011444092,125.509330749512],  # F
        [693556.305522918701,5677023.742652893066,125.547370910645],  # G
        [693547.636817932129,5677022.412660598755,123.830909729004],  # H
        [693555.543304443359,5677023.247108459473,121.168823242188],  # I
        [693560.240524291992,5677024.292545318604,123.194335937500],  # J
        [693564.496482849121,5677025.588584899902,122.737701416016],  # K
        [693557.725593566895,5677029.618289947510,129.558578491211],  # L
        [693557.164424896240,5677029.903480529785,138.583099365234],  # M
        [693553.730228424072,5677029.200395584106,143.161529541016],  # N
        [693553.217575073242,5677032.498676300049,148.312927246094],  # N
        [693556.326961517334,5677033.315242767334,143.282836914063],  # N
        [693566.869636535645,5677035.639011383057,135.976333618164],  # N
        [693563.684494018555,5677031.023429870605,128.860015869141],  # N
        [693566.509941101074,5677031.638755798340,128.798812866211],  # N
        [693568.770545959473,5677033.274021148682,128.755432128906],  # N
        [693569.280227661133,5677036.041084289551,128.787567138672],  # N
        [693565.116798400879,5677031.404344558716,132.776580810547],  # N
        [693567.810981750488,5677032.103549957275,132.876190185547],  # N
        [693569.807846069336,5677034.593513488770,132.925094604492],  # N
        [693569.202919006348,5677037.533611297607,132.919540405273],  # N
        [693563.069824218750,5677031.156883239746,123.817741394043],  # N
        [693565.900283813477,5677031.768226623535,123.790184020996],  # N
        [693568.831733703613,5677033.815696716309,123.779541015625],  # N
        [693569.425689697266,5677037.562091827393,123.156654357910],  # N
        [693565.551895141602,5677030.869075775146,120.697448730469],  # N
        [693568.466667175293,5677031.764606475830,120.737350463867],  # N
        [693570.166748046875,5677034.742134094238,120.741714477539]  # N
    ])

    image_points = np.array([
        [-109.5640562150900,95.41800337637950],  # A
        [-176.92445486670900,79.76506478631640],  # B
        [-162.19649225658300,42.959271744263700],  # C
        [-175.73892227270500,-25.9840083378117],  # D
        [-139.4726985522820,-6.339125289733550],  # E
        [-168.85371374599000,-81.16772789204280],  # F
        [-154.32116859641400,-78.56433305649200],  # G
        [-180.64064357483700,-104.13687907459000],  # H
        [-157.31431270050600,-141.61360539786500],  # I
        [-127.70856742716600,-112.10556885479900],  # J
        [-80.72043903789470,-121.37812735790200],  # K
        [-59.3841093034996,-24.20462379424710],  # L
        [-58.003159248945600,97.30378187068790],  # M
        [-82.64204406663740,132.81222010520000],  # N
        [-46.483299949517200,174.13215648596000],  # N
        [-22.489292751640700,135.34070491420600],  # N
        [96.0248831566434,101.64856341025200],  # N
        [0.7556141807937420,-19.048859793400400],  # N
        [38.3897601250672,-8.601625221880260],  # N
        [91.92111648509130,-4.091824493407360],  # N
        [138.22854072011300,-9.422378556190670] , # N
        [20.90315436350900,51.19720335900900],  # N
        [63.136124546061500,67.54821654425930] , # N
        [121.96655104466900,70.07887265838320],  # N
        [148.51401306040000,49.674032819276900],  # N
        [-5.44889019167195,-101.14047801282200],  # N
        [34.87550279284120,-99.89306322297680] , # N
        [102.98174475222700,-101.31852503243400] , # N
        [159.2424316446010,-113.890381661157] , # N
        [18.62979790577620,-157.00924433153700],  # N
        [69.5588450828082,-161.03375836631000],  # N
        [137.66834399987000,-163.11603997372700]  # N
    ])

# -------- final data --------
# BLDAM_MBA-4-b-29_141_13.tif (Final)
if data == "dataset_14":
    object_points = 1000 * np.array([
        [693532.599365, 5677023.91168, 145.264694214],
        [693554.933716, 5677022.9364, 132.352478027],
        [693552.026611, 5677022.44135, 128.027191162],
        [693558.844849, 5677023.84735, 128.036499023],
        [693553.251587, 5677022.80054, 123.751487732],
        [693556.202881, 5677023.44214, 123.759788513],
        [693547.639526, 5677022.36981, 122.253227234],
        [693555.570435, 5677023.25183, 119.59563446],
        [693560.211426, 5677024.31311, 121.64641571],
        [693564.404785, 5677025.70544, 121.248725891],
        [693557.587402, 5677029.4436, 128.128219604],
        [693556.977173, 5677029.83612, 137.152420044],
        [693553.442505, 5677029.10815, 141.568359375],
        [693552.883545, 5677032.3136, 146.870010376],
        [693556.14856, 5677033.32288, 141.716690063],
        [693566.62439, 5677035.65656, 134.481063843],
        [693563.553955, 5677031.01782, 127.354057312],
        [693566.389282, 5677031.64276, 127.371391296],
        [693568.687256, 5677033.32178, 127.363090515],
        [693569.142456, 5677036.1156, 127.380638123],
        [693564.92749, 5677031.35846, 131.319732666],
        [693567.705078, 5677032.15662, 131.448684692],
        [693569.360474, 5677034.56409, 131.399978638],
        [693568.619263, 5677037.56732, 131.335723877],
        [693562.999512, 5677031.17719, 122.314598083],
        [693565.901978, 5677031.81854, 122.306526184],
        [693568.739868, 5677033.86517, 122.395576477],
        [693569.330933, 5677037.64587, 121.730155945],
        [693565.487793, 5677030.90125, 119.289634705],
        [693568.390015, 5677031.78833, 119.318061829],
        [693570.091919, 5677034.89355, 119.33997345]
    ])


    image_points = np.array([
        [-175.05914464265400, 81.57874037035240],
        [-162.82808982469100, 46.04107075519740],
        [-176.28495779155000, -27.42759191013900],
        [-140.24810222295600, -4.58065180448966],
        [-169.62656967499500, -81.92162770750990],
        [-154.12931108314700, -79.26362911499390],
        [-181.65379500221700, -103.66317459576800],
        [-157.26380599355700, -142.92856690780900],
        [-128.30530637085600, -112.66717364403200],
        [-80.82648953475490, -121.44585511075000],
        [-58.82969821806730, -23.47966518257260],
        [-57.27178369176860, 99.52851943282060],
        [-82.14251633926210, 134.25080122775500],
        [-46.39869797258890, 180.03106691724000],
        [-20.32028711889560, 137.16852908429900],
        [95.98622582642180, 104.97651888178700],
        [1.41026423785104, -16.59516311179410],
        [38.80858176784390, -6.48593850354311],
        [92.49028949264490, -0.43128470420973],
        [138.33345465209500, -5.71862644435109],
        [20.52382320917780, 55.27484427770610],
        [63.37563096816700, 71.65908040192510],
        [122.07888755958300, 75.58818758572360],
        [148.44389477653600, 53.70251121453400],
        [-0.32022564451352800, -102.77334688750300],
        [35.53473561055860, -101.90748021677500],
        [101.10878827985300, -101.64068139881600],
        [160.16494973840600, -114.04002233755500],
        [17.54935729232170, -157.08268010981000],
        [66.51300399737160, -161.95472048506600],
        [137.32074803704600, -163.23273097287500]
    ])

# BLDAM_MBA-4-b-24_141_8.tif (Final)
if data == "dataset_15":
    object_points = 1000 * np.array([
        [693552.710815, 5677033.00500, 146.852920532],
        [693551.845581, 5677036.01477, 141.529510498],
        [693548.594727, 5677035.43896, 137.081130981],
        [693550.716431, 5677042.33582, 132.38218689],
        [693546.990845, 5677041.56165, 128.156005859],
        [693543.809692, 5677039.58350, 126.609718323],
        [693543.160767, 5677039.41693, 126.569770813],
        [693544.012329, 5677039.82245, 122.320503235],
        [693548.722412, 5677041.69958, 123.794776917],
        [693551.931641, 5677042.37415, 123.807243347],
        [693555.394897, 5677036.93140, 137.179840088],
        [693552.027344, 5677035.74872, 134.751953125],
        [693555.767944, 5677033.35535, 134.965682983],
        [693566.624390, 5677035.65656, 134.481063843],
        [693560.152832, 5677038.15924, 131.014129639],
        [693563.246704, 5677038.72394, 131.261062622],
        [693566.089355, 5677039.27124, 131.400970459],
        [693568.619263, 5677037.56732, 131.335723877],
        [693567.507324, 5677038.52301, 127.499977112],
        [693564.749756, 5677039.07318, 127.506431580],
        [693561.811768, 5677038.49902, 127.444633484],
        [693555.700073, 5677037.05389, 127.623451233],
        [693557.409790, 5677037.22870, 123.763298035],
        [693558.247803, 5677037.41113, 123.792778015],
        [693556.752563, 5677039.92883, 121.643730164],
        [693560.420654, 5677038.74744, 121.641334534],
        [693562.934570, 5677039.22906, 121.663337708],
        [693565.982300, 5677039.92975, 121.716743469],
        [693569.036499, 5677038.19751, 121.740303040],
        [693569.014160, 5677038.20837, 119.284080505],
        [693565.995728, 5677039.96362, 119.286933899],
        [693562.908569, 5677039.26355, 119.269233704],
        [693560.501587, 5677038.80634, 119.250190735]
    ])

    image_points = np.array([
        [-35.94040990172790, 164.6003277829160],
        [-56.53966360152570, 123.3512055265910],
        [-93.12906078202990, 67.28636996384760],
        [-105.76021204728800, 48.77522045562890],
        [-156.02768811952800, -21.79951537998620],
        [-177.92196499286200, -50.31639457273580],
        [-189.89112358155100, -51.05488877798980],
        [-181.36925048154800, -106.94138627196800],
        [-132.45630796616500, -85.69042836511740],
        [-88.97024349814580, -85.45266266211670],
        [-19.82564629965750, 80.86174345011690],
        [-56.37598591224420, 43.04549455024870],
        [-7.31926686241880, 32.53145103071230],
        [125.42560095315900, 43.22723912299490],
        [41.31465953130510, 6.39993832434897],
        [84.74521315509090, 14.10572616079900],
        [128.22400949518200, 17.65669625245250],
        [159.32151543087700, 9.47958342180016],
        [144.76557908395500, -38.63167217074500],
        [105.29074890748800, -37.04566184131470],
        [62.55197763071580, -40.17902488616660],
        [-19.55959420124760, -41.93716710301870],
        [1.38320611466088, -90.88144393842610],
        [13.97099685960330, -90.93440335255160],
        [-11.53581542430520, -118.96277332453600],
        [41.31641105359520, -120.39470485849500],
        [77.03211581617040, -120.70273832581100],
        [125.12581481127200, -121.06284855035000],
        [163.57174287018400, -121.17200838441300],
        [163.04955477199800, -155.61630104558300],
        [123.78748628347700, -157.65990002117700],
        [75.24684569109310, -155.45725730503800],
        [41.38478938047900, -153.84227100449300]
    ])

# BLDAM_MBA-4-b-25_141_9.tif (Final)
if data == "dataset_16":
    object_points = 1000 * np.array([
        [693566.624390, 5677035.65656, 134.481063843],
        [693568.619263, 5677037.56732, 131.335723877],
        [693566.089355, 5677039.27124, 131.400970459],
        [693563.246704, 5677038.72394, 131.261062622],
        [693560.152832, 5677038.15924, 131.014129639],
        [693555.776855, 5677033.26617, 135.665237427],
        [693555.700073, 5677037.05389, 127.623451233],
        [693567.507324, 5677038.52301, 127.499977112],
        [693564.749756, 5677039.07318, 127.506431580],
        [693561.811768, 5677038.49902, 127.444633484],
        [693558.247803, 5677037.41113, 123.792778015],
        [693557.409790, 5677037.22870, 123.763298035],
        [693556.752563, 5677039.92883, 121.643730164],
        [693569.036499, 5677038.19751, 121.740303040],
        [693565.982300, 5677039.92975, 121.716743469],
        [693562.934570, 5677039.22906, 121.663337708],
        [693560.420654, 5677038.74744, 121.641334534],
        [693569.014160, 5677038.20837, 119.284080505],
        [693565.995728, 5677039.96362, 119.286933899],
        [693562.908569, 5677039.26355, 119.269233704],
        [693560.501587, 5677038.80634, 119.250190735]
    ])

    image_points = np.array([
        [-82.13595330119760, 178.0197159141240],
        [-142.7323811478030, 135.56655992142100],
        [-84.82779480244840, 166.9460740287250],
        [-3.36112970556474, 154.21570837019500],
        [74.88305116483510, 133.59177287930700],
        [131.62585791445400, 161.3156127255580],
        [174.48631653777600, 33.61858533396570],
        [-117.77448497100900, 52.66383769340570],
        [-43.40584609622990, 58.75204492270500],
        [34.35725234149960, 47.61444839506510],
        [115.44722557669900, -52.97995274953100],
        [136.76485098834700, -53.95079346925410],
        [188.41830905215400, -104.81326309675600],
        [-155.4066130473640, -103.79803395889200],
        [-81.40538749533270, -103.11494007353300],
        [7.93671083363333, -104.35183098370500],
        [73.63412057951910, -105.30495558074700],
        [-154.68431663420600, -169.29940303394200],
        [-80.57326233428970, -176.24755702517200],
        [11.09334826869760, -171.97490197265700],
        [72.34518855897290, -168.57897073812300],
    ])

# BLDAM_MBA-4-b-31_141_15.tif (Final)
if data == "dataset_17":    
    object_points = 1000 * np.array([
        [693554.933716, 5677022.93640, 132.352478027],
        [693552.026611, 5677022.44135, 128.027191162],
        [693558.844849, 5677023.84735, 128.036499023],
        [693556.202881, 5677023.44214, 123.759788513],
        [693555.570435, 5677023.25183, 119.595634460],
        [693560.211426, 5677024.31311, 121.646415710],
        [693564.404785, 5677025.70544, 121.248725891],
        [693557.587402, 5677029.44360, 128.128219604],
        [693556.977173, 5677029.83612, 137.152420044],
        [693553.442505, 5677029.10815, 141.568359375],
        [693556.148560, 5677033.32288, 141.716690063],
        [693566.624390, 5677035.65656, 134.481063843],
        [693563.553955, 5677031.01782, 127.354057312],
        [693566.389282, 5677031.64276, 127.371391296],
        [693568.687256, 5677033.32178, 127.363090515],
        [693564.927490, 5677031.35846, 131.319732666],
        [693567.705078, 5677032.15662, 131.448684692],
        [693569.360474, 5677034.56409, 131.399978638],
        [693562.999512, 5677031.17719, 122.314598083],
        [693565.901978, 5677031.81854, 122.306526184],
        [693568.739868, 5677033.86517, 122.395576477],
        [693565.487793, 5677030.90125, 119.289634705],
        [693568.390015, 5677031.78833, 119.318061829],
        [693570.091919, 5677034.89355, 119.339973450]
    ])

    image_points = np.array([
        [-128.42891623914900, 121.88107169733300],
        [-162.64378881260100, 48.13320409025780],
        [-77.78520283220320, 62.08549587465920],
        [-111.73391007570600, -10.76862065729610],
        [-120.30659052358800, -76.65494968127940],
        [-55.64514597578450, -47.06216655695420],
        [19.60545654173860, -56.08162551305990],
        [-33.62744311204690, 37.95280299038870],
        [-37.37130617981230, 146.66039579929500],
        [-72.04526612582520, 187.29639260176300],
        [-19.38093065826230, 169.88628023208900],
        [100.06607697780800, 113.69964125482200],
        [42.11436348824900, 34.71773403787720],
        [83.24002576544710, 37.51434128239240],
        [122.14054200309900, 36.47421452326790],
        [63.03763088737620, 87.70650788231670],
        [105.43393390333900, 92.39502084259450],
        [134.51214273625200, 85.36995830372210],
        [36.11646736147990, -34.01116641321220],
        [75.91526733037500, -34.31597714155180],
        [123.88499085082700, -34.57679199668770],
        [67.19576763580950, -78.11432633987460],
        [115.00170563711300, -80.32080116291040],
        [145.85349984121800, -75.62014567430050]
    ])

# BLDAM_MBA-4-b-35_141_19.tif (Final)
if data == "dataset_18":    
    object_points = 1000 * np.array([
        [693521.441528, 5677025.48987, 131.836105347],
        [693522.048645, 5677022.79865, 128.183059692],
        [693525.157837, 5677023.59967, 127.730537415],
        [693524.792236, 5677023.55194, 125.468360901],
        [693525.524414, 5677023.71899, 125.485923767],
        [693521.255005, 5677022.43146, 125.181663513],
        [693521.988647, 5677021.98450, 125.215492249],
        [693525.318481, 5677023.66125, 123.800941467],
        [693523.932861, 5677023.30157, 118.677986145],
        [693523.131226, 5677027.14386, 118.738426208],
        [693522.063965, 5677022.24066, 118.988334656],
        [693526.940063, 5677024.18774, 121.082328796],
        [693529.384033, 5677018.38538, 119.045265198],
        [693531.692749, 5677018.86292, 119.100685120],
        [693530.968628, 5677018.78064, 120.613777161],
        [693531.502930, 5677018.89575, 120.636528015],
        [693532.801514, 5677019.16907, 120.673042297],
        [693531.495239, 5677018.81543, 123.806129456],
        [693531.147827, 5677018.69531, 125.882850647],
        [693531.372070, 5677018.73462, 126.486824036]
    ])

    image_points = np.array([
        [-110.4045603676850, 142.82239420131700],
        [-134.2318962648310, 98.08531199242920],
        [-53.80597263177570, 83.64740521974820],
        [-62.79035965568660, 25.72983564903290],
        [-46.08212454961780, 26.93800512072380],
        [-158.0572859059730, 23.71859401914150],
        [-148.7151742679010, 29.99332337568030],
        [-49.21040669986900, -15.02744289981650],
        [-85.76168799197320, -141.57364322145900],
        [-64.07261108463190, -134.23460169870900],
        [-143.7324138170930, -136.34757316369700],
        [-7.25789230965239, -82.35169563758440],
        [31.06932688114960, -149.97972995076800],
        [134.48133450771200, -147.99416233624700],
        [101.35433191726000, -79.22675386997820],
        [129.99213629755000, -78.58153549660380],
        [187.0059667239920, -77.81562164452000],
        [127.9999431306760, 61.74520637836400],
        [112.6910660914030, 156.8289223028380],
        [121.8373650509570, 183.8555165798240]
    ])


# DSC_4369.jpg (Final)
if data == "dataset_19":    
    object_points = 1000 * np.array([
        [693554.933716, 5677022.9364, 132.352478027],
        [693558.844849, 5677023.84735, 128.036499023],
        [693556.202881, 5677023.44214, 123.759788513],
        [693555.570435, 5677023.25183, 119.59563446],
        [693560.211426, 5677024.31311, 121.64641571],
        [693564.404785, 5677025.70544, 121.248725891],
        [693557.587402, 5677029.4436, 128.128219604],
        [693566.62439, 5677035.65656, 134.481063843],
        [693563.553955, 5677031.01782, 127.354057312],
        [693566.389282, 5677031.64276, 127.371391296],
        [693568.687256, 5677033.32178, 127.363090515],
        [693569.142456, 5677036.1156, 127.380638123],
        [693564.92749, 5677031.35846, 131.319732666],
        [693567.705078, 5677032.15662, 131.448684692],
        [693569.360474, 5677034.56409, 131.399978638],
        [693568.619263, 5677037.56732, 131.335723877],
        [693562.999512, 5677031.17719, 122.314598083],
        [693565.901978, 5677031.81854, 122.306526184],
        [693568.739868, 5677033.86517, 122.395576477],
        [693569.330933, 5677037.64587, 121.730155945],
        [693565.487793, 5677030.90125, 119.289634705],
        [693568.390015, 5677031.78833, 119.318061829],
        [693570.091919, 5677034.89355, 119.33997345]
    ])


    image_points = np.array([
        [-16.762,  9.256],
        [-14.107,  4.733],
        [-16.737, -2.327],
        [-17.891, -8.826],
        [-13.310, -5.501],
        [-7.486, -6.068],
        [-7.481,  2.596],
        [ 6.606, 11.823],
        [-0.895,  3.022],
        [ 2.885,  3.780],
        [ 7.427,  4.034],
        [10.591,  3.330],
        [ 0.973,  9.017],
        [ 4.792, 10.171],
        [ 9.207,  9.730],
        [10.669,  8.073],
        [-1.340, -4.763],
        [ 2.479, -4.591],
        [ 8.601, -4.459],
        [12.635, -5.540],
        [ 1.120, -9.677],
        [ 6.190, -9.784],
        [11.760, -9.574]
    ])



# -------- Analysis output --------
# def log(msg):
#     with open(OUTPUT_FILE, "a", encoding="utf-8") as f:
#         f.write(msg + "\n")
#     print(msg)

# -------- Main Procedure --------

# Step 1: shifted lens simulation
# image_points = world_to_image(iop, eop, X, Y, Z, delta=0)
# shifted_points = world_to_image(iop, eop, X, Y, Z, delta=30)

# print("\n===== shifted lens simulation =====\n")
# print("object points (X, Y, Z):")
# for i, (X, Y, Z) in enumerate(object_points, 1):
#     print(f"  point {i:01d}: ({X:.3f}, {Y:.3f}, {Z:.3f})")

# print("\nimage points (x, y):")
# print(f"{' ':<2}  {'x':>10}  {'y':>10}  {'shifted y':>12}  {'Δy':>8}")
# for i, (img, shifted) in enumerate(zip(image_points, shifted_points), 1):
#     delta_y = shifted[1] - img[1]
#     print(f"{i:<2}  {img[0]:>10.3f}  {img[1]:>10.3f}  {shifted[1]:>12.3f}  {delta_y:>8.3f}")

# Step 1：estimate focal length using PNP
best_focal, rp_err = estimate_focal_length(object_points, image_points)

# Step 2: DLT
DLT_cam_est = DLT_USV(object_points, image_points)
# res = estimate_camera(object_points, image_points, angles="cam2world", xyz_scale=1000, report=True)

iop_init = {
    "x0": 0,
    # DLT_cam_est["x0_est"],
    "y0": 0,
    # DLT_cam_est["y0_est"],
    "f": best_focal
    # DLT_cam_est["c"]  
}

eop_init = {
    "omega": DLT_cam_est["rotation_angles"][0],
    "phi":   DLT_cam_est["rotation_angles"][1],
    "kappa": DLT_cam_est["rotation_angles"][2],
    "XL":    DLT_cam_est["position"][0],
    "YL":    DLT_cam_est["position"][1],
    "ZL":    DLT_cam_est["position"][2]
}

# DLT_cam_est_shifted = DLT_USV(object_points, shifted_points)
# print("\n===== DLT results comparison =====\n")
# print(f"{'Parameter':<10}{'Original':>20}{'Shifted':>20}{'ΔValue':>20}")

# param_map = {
#     'position': ['X', 'Y', 'Z'],
#     'rotation_angles': ['omega', 'phi', 'kappa'],
#     'c': ['c'],
#     'x0_est': ['x0'],
#     'y0_est': ['y0'],
# }

# for key, labels in param_map.items():
#     v1 = DLT_cam_est[key]
#     v2 = DLT_cam_est_shifted[key]

#     if np.isscalar(v1):
#         diff = v2 - v1
#         print(f"{labels[0]:<10}{v1:20.6f}{v2:20.6f}{diff:20.6f}")
#     else:
#         for i, label in enumerate(labels):
#             val1 = v1[i]
#             val2 = v2[i]
#             diff = val2 - val1
#             print(f"{label:<10}{val1:20.6f}{val2:20.6f}{diff:20.6f}")



# # Step 3: Spatial Resection
SR_cam_est = spatial_resection(iop_init, eop_init, object_points, image_points, delta =0)


# SR_cam_est_shifted = spatial_resection(iop, copy.deepcopy(eop), object_points, shifted_points, delta=0)
# print("\n===== Spatial Resection results comparison =====\n")
# print(f"{'Parameter':>10} {'Original':>15} {'Shifted':>15} {'ΔValue':>15}")

# EOP translation (meters)
# for key in ['XL', 'YL', 'ZL']:
#     val1 = SR_cam_est[key]
#     val2 = SR_cam_est_shifted[key]
#     print(f"{key:>10}  {val1:15.3f}  {val2:15.3f}  {val2 - val1:15.3f}")

# # EOP rotation (degrees)
# for key in ['omega', 'phi', 'kappa']:
#     deg1 = np.degrees(SR_cam_est[key])
#     deg2 = np.degrees(SR_cam_est_shifted[key])
#     print(f"{key:>10}  {deg1:15.6f}°  {deg2:15.6f}°  {deg2 - deg1:15.6f}°")


